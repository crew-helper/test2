# Create release branch
# TODO

name: Create release branch

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version:"
        required: true

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
      TAG: v${{ github.event.inputs.version }}
    steps:

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
      with:
        fetch-depth: 0 #needs for tags

    - name: Create branch
      run: |
        git checkout -b "release/${VERSION}"

    - name: Create all-in-one configuration
      uses: ./.github/actions/all-in-one
      with:
        IMAGE_URL: leori/atlas-ci:v4 #${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ env.VERSION }}
        version: ${{ env.VERSION }}

    - name: Commit file
      uses: ./.github/actions/put-contents
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        FILE_TO_COMMIT: "deploy/all-in-one.yaml"
        DESTINATION_BRANCH: "release/${{ env.VERSION }}"

    - name: Commit file
      uses: ./.github/actions/put-contents
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        FILE_TO_COMMIT: "deploy/all-in-one-${{ env.VERSION }}.yaml"
        DESTINATION_BRANCH: "release/${{ env.VERSION }}"
              #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     FILE_TO_COMMIT: ao-all-in-one-.tar.gz
      #     DESTINATION_BRANCH: sign

    - name: Create PR
      uses: ./.github/actions/crate-pr

#TODO: create PR. deploy/all-in-one.yaml (trigger create branch: release/)
